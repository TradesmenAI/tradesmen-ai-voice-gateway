import express from "express";
import { WebSocketServer } from "ws";
import OpenAI from "openai";
import cors from "cors";
import { createClient } from "@supabase/supabase-js";
import Twilio from "twilio";

// Load env vars
const {
  OPENAI_API_KEY,
  SUPABASE_URL,
  SUPABASE_SERVICE_ROLE,
  TWILIO_AUTH_TOKEN,
  TWILIO_ACCOUNT_SID
} = process.env;

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE);
const twilio = Twilio(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN);

const app = express();
app.use(express.json());
app.use(cors());

// -------------------------
// TWILIO WEBHOOK
// -------------------------
app.post("/voice", (req, res) => {
  const host = req.headers.host;

  const twiml = `
<Response>
  <Connect>
    <Stream url="wss://${host}/stream" />
  </Connect>
</Response>`;

  res.type("text/xml");
  res.send(twiml);
});

// -------------------------
// WEBSOCKET SERVER
// -------------------------
const wss = new WebSocketServer({ noServer: true });

wss.on("connection", async (ws) => {
  console.log("ðŸ”Œ Twilio WebSocket connected");

  // NEW REALTIME API â€” FIXED
  const session = openai.realtime.connect({
    model: "gpt-4o-realtime-preview-2024-12-17"
  });

  // Send greeting when call connects
  session.send({
    type: "response.create",
    response: {
      instructions: "Hi, you're through to Tradesmen AI, how can I help?"
    }
  });

  // Twilio â†’ OpenAI
  ws.on("message", (msg) => {
    session.send(msg);
  });

  // OpenAI â†’ Twilio
  session.on("message", (msg) => {
    ws.send(msg);
  });

  ws.on("close", () => {
    console.log("âŒ Twilio disconnected");
    session.close();
  });
});

// -------------------------
// SERVER + WS UPGRADE
// -------------------------
const server = app.listen(10000, () => {
  console.log("ðŸš€ Server running on port 10000");
});

server.on("upgrade", (req, socket, head) => {
  if (req.url === "/stream") {
    wss.handleUpgrade(req, socket, head, (ws) => {
      wss.emit("connection", ws);
    });
  } else {
    socket.destroy();
  }
});
